From 623054471974393f6fccefa4452f32605ed95ab7 Mon Sep 17 00:00:00 2001
From: kongfl888 K <kongfl888@outlook.com>
Date: Fri, 24 Jul 2020 13:36:53 +0800
Subject: [PATCH] patch autocore

patch cpufreq

Signed-off-by: kongfl888 K <kongfl888@outlook.com>
---
 package/lean/autocore/Makefile           |  2 +-
 package/lean/autocore/files/autocore     |  4 ++--
 package/lean/autocore/files/index.htm    |  1 +
 package/lean/autocore/files/sbin/cpuinfo | 21 ++++++++++++++++-----
 4 files changed, 20 insertions(+), 8 deletions(-)

diff --git a/package/lean/autocore/Makefile b/package/lean/autocore/Makefile
index c6cde39..347a452 100644
--- a/package/lean/autocore/Makefile
+++ b/package/lean/autocore/Makefile
@@ -17,7 +17,7 @@ include $(INCLUDE_DIR)/package.mk
 define Package/autocore
   TITLE:=x86/x64 auto core loadbalance script.
   MAINTAINER:=Lean
-  DEPENDS:=@TARGET_x86 +bc +lm-sensors +ethtool
+  DEPENDS:=+bc +lm-sensors +ethtool
 endef
 
 define Package/autocore/description
diff --git a/package/lean/autocore/files/autocore b/package/lean/autocore/files/autocore
index 614e217..90f9f52 100755
--- a/package/lean/autocore/files/autocore
+++ b/package/lean/autocore/files/autocore
@@ -31,7 +31,7 @@ start()
 	g=${a}${b}${c}${d}${e}${f}
 
 	mkdir -p /tmp/sysinfo
-	echo $g > /tmp/sysinfo/model
+	#echo $g > /tmp/sysinfo/model
 
 	a=$(ip address | grep ^[0-9] | awk -F: '{print $2}' | sed "s/ //g" | grep '^[e]' | grep -v "@" | grep -v "\.")
 	b=$(echo "$a" | wc -l)
@@ -42,7 +42,7 @@ start()
 		ethtool -K $c tx-checksum-ip-generic on >/dev/null 2>&1 || (
 		ethtool -K $c tx-checksum-ipv4 on >/dev/null 2>&1
 		ethtool -K $c tx-checksum-ipv6 on >/dev/null 2>&1)
-		ethtool -K $c tx-scatter-gather on >/dev/null 2>&1
+		#ethtool -K $c tx-scatter-gather on >/dev/null 2>&1
 		ethtool -K $c gso on >/dev/null 2>&1
 		ethtool -K $c tso on >/dev/null 2>&1
 		ethtool -K $c ufo on >/dev/null 2>&1
diff --git a/package/lean/autocore/files/index.htm b/package/lean/autocore/files/index.htm
index c24224c..9727538 100644
--- a/package/lean/autocore/files/index.htm
+++ b/package/lean/autocore/files/index.htm
@@ -718,6 +718,7 @@
 		<tr><td width="33%"><%:Firmware Version%></td><td>
 			<%=pcdata(ver.distname)%> <%=pcdata(ver.distversion)%> /
 			<%=pcdata(ver.luciname)%> (<%=pcdata(ver.luciversion)%>)
+			built by Mr.K
 		</td></tr>
 		<tr><td width="33%"><%:Kernel Version%></td><td><%=unameinfo.release or "?"%></td></tr>
 		<tr><td width="33%"><%:Local Time%></td><td id="localtime">-</td></tr>
diff --git a/package/lean/autocore/files/sbin/cpuinfo b/package/lean/autocore/files/sbin/cpuinfo
index 8c0527f..90efcca 100755
--- a/package/lean/autocore/files/sbin/cpuinfo
+++ b/package/lean/autocore/files/sbin/cpuinfo
@@ -1,5 +1,16 @@
-#!/bin/sh
-
-MHz=`grep 'MHz' /proc/cpuinfo | cut -c11- |sed -n '1p'`
-TEMP=`sensors 2>/dev/null | grep 'Core 0' | cut -c12-`
-echo "$MHz MHz $TEMP "
+#!/bin/sh
+#
+# [K] (c)2020
+#
+MHz=`grep 'MHz' /proc/cpuinfo | cut -c11- |sed -n '1p'`
+[ -z "$MHz" ] && MHz=`echo "$(cat /sys/devices/system/cpu/cpu[04]/cpufreq/cpuinfo_cur_freq)/1000" | bc`
+TEMP=`echo "scale=2; $(cat /sys/class/thermal/thermal_zone0/temp)/1000" | bc`
+[ -z "$TEMP" ] && TEMP=`sensors 2>/dev/null | grep 'Core 0' | cut -c12-` || TEMP="$TEMP""â„ƒ"
+MIN=`echo "$(cat /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq)/1000" | bc`
+[ ! -z "$MIN" ] && MIN="$MIN""MHz" || MIN=""
+MAX=`echo "$(cat /sys/devices/system/cpu/cpufreq/policy0/scaling_max_freq)/1000" | bc`
+[ ! -z "$MAX" ] && MAX="$MAX""MHz" || MAX=""
+GOV=`cat /sys/devices/system/cpu/cpufreq/policy0/scaling_governor`
+PLUS="$MIN$MAX$GOV"
+[ ! -z "$PLUS" ] && PLUS="(mini-max : $MIN - $MAX / $GOV)"
+echo "$MHz MHz $TEMP $PLUS"
-- 
2.14.1.windows.1

